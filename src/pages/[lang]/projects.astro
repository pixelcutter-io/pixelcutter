---
import ContactsCta from "@/components/blocks/ContactsCta.astro";
import HeroPage from "@/components/blocks/HeroPage.astro";
import ProjectCard from "@/components/blocks/ProjectCard.astro";
import Layout from "@/components/layouts/Layout.astro";
import MarkdownText from "@/components/typography/MarkdownText.astro";
import { getStaticPaths, useTranslations } from "@/i18n/i18n";
import Section from "../../components/layouts/Section.astro";

export { getStaticPaths };

const { lang } = Astro.params;
const t = useTranslations(lang as "en" | "it");

// Importa tutti i progetti (tutte le lingue)
const allProjects = import.meta.glob("../../content/*/projects/*.md");

// Filtra solo i progetti della lingua corrente
const projectEntries = Object.entries(allProjects).filter(([path]) =>
	path.includes(`/${lang}/projects/`),
);

// Carica tutti i progetti in parallelo
const projects = await Promise.all(
	projectEntries.map(async ([path, resolver]) => {
		const module = await resolver();
		const slug = path.split("/").pop()?.replace(".md", "") || "";
		return {
			...module.frontmatter,
			slug: module.frontmatter?.slug || slug,
			url: `/${lang}/projects/${module.frontmatter?.slug || slug}`,
		};
	}),
);

// Ordina solo per data (dal più recente al più vecchio)
projects.sort(
	(a, b) => new Date(b.date || 0).getTime() - new Date(a.date || 0).getTime(),
);
---

<Layout theme="default">
  <HeroPage title={t('projects.title')} />
  <Section maxWidth="sm" padding={["st", "uxxs"]}>
    <MarkdownText text={t('projects.text')} size={['lg', 'xxl']}/>
  </Section>
  <Section  maxWidth="sm">
    <div class="list">
      {projects.map((project) => (
        <ProjectCard
          url={project.url}
          logo={project.logo}
          title={project.title}
          excerpt={project.excerpt}
          cover={project.cover}
          date={new Date(project.date).getFullYear().toString()}
        />
      ))}
    </div>
  </Section>
  <Section bgColor="secondary">
    <ContactsCta color="primary" align="center" />
  </section>
</Layout>

<style lang="scss">
@use '@/styles/mixins/media';

.list {
  display: flex;
  flex-direction: column;
  align-items: stretch;
  gap: var(--s-sp);
}

</style>

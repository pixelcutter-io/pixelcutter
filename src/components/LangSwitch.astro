---
import FlagEn from "@/assets/icons/flag_en.svg";
import FlagIt from "@/assets/icons/flag_it.svg";
import Lang from "@/assets/icons/langs.svg";
import Button from "@/components/Button.astro";
import { getLocalizedUrl, LANGUAGES, useTranslations } from "@/i18n/i18n";

interface Props {
	class?: string;
}

const { class: className } = Astro.props;
const { lang } = Astro.params;
const t = useTranslations(lang as "en" | "it");

const currentPath = Astro.url.pathname;

const flags = {
	it: FlagIt,
	en: FlagEn,
};
---

<div class:list={["switch-lang", className]}>
  <Button
    class="btn-lang"
    icon={Lang}
    theme="ghost"
    size="big"
    labelColor="secondary"
    hoverBgColor="secondary"
  />
  
  <div class="dropdown-lang">
    {LANGUAGES.map((lang) => {
      const FlagIcon = flags[lang];
      return (
        <a
          href={getLocalizedUrl(lang, currentPath)}
          class="item-lang"
          data-lang={lang}
        >
          {FlagIcon && <FlagIcon width="1rem" height="1rem" />}
          <span>{t(`label.${lang}`)}</span>
        </a>
      );
    })}
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const dropdown = document.querySelector('.switch-lang');
    const button = dropdown?.querySelector('.btn-lang');
    const menu = dropdown?.querySelector('.dropdown-lang');
    
    if (!dropdown || !button || !menu) return;
    
    button.addEventListener('click', (e) => {
      e.preventDefault();
      dropdown.classList.toggle('open');
    });
    
    document.addEventListener('click', (e) => {
      if (!dropdown.contains(e.target)) {
        dropdown.classList.remove('open');
      }
    });
    
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        dropdown.classList.remove('open');
      }
    });
  });
</script>

<style lang="scss">
  @use '@/styles/mixins/media';
  .switch-lang {
    @include media.media(sm) {
      position: relative;
    }
  }
  
  .dropdown-lang {
    visibility: hidden;
    position: absolute;
    top: 4rem;
    right: var(--s-xxl);
    left: var(--s-xxl);
    z-index: var(--z-index-top);
    padding: var(--s-xxs);
    background: var(--c-primary);
    border-radius: var(--s-xxs);
    border: 1px solid var(--c-secondary);
    box-shadow: var(--sw-dp8);
    transform: translateY(-0.5rem);
    transition: var(--transition-025);
    overflow: hidden;
    opacity: 0;
    
    @include media.media(sm) {
      width: 10rem;
      top: 3rem;
      right: 0;
      left: initial;
    }
  }
  
  .switch-lang.open .dropdown-lang {
    opacity: 1;
    visibility: visible;
    transform: translateY(0);
  }
  
  .item-lang {
    min-height: var(--s-big);
    display: flex;
    align-items: center;
    gap: var(--s-xxs);
    padding-inline: var(--s-xxs);
    font-size: var(--fs-df);
    font-weight: var(--fw-regular);
    color: var(--c-secondary);
    text-decoration: none;
    transition: background-color var(--transition-025);
    cursor: pointer;
    border-radius: var(--s-uxs);
  }
  
  .item-lang:hover {
    background-color: color-mix(in srgb, var(--c-secondary), transparent 75%);
  }
</style>
